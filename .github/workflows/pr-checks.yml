name: Pull Request Checks

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  # Job 1: PR Validation
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"
          
          # Check if PR title follows conventional commits (optional)
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: ]]; then
            echo "‚ö†Ô∏è  Warning: PR title doesn't follow conventional commits format"
            echo "Recommended format: type(scope): description"
            echo "Examples: feat(auth): add OAuth support, fix(api): resolve login issue"
          fi
      
      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
            echo "‚ùå Merge conflicts detected"
            exit 1
          else
            echo "‚úÖ No merge conflicts"
          fi

  # Job 2: Code Quality Analysis
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check code formatting (Prettier)
        run: npx prettier --check "src/**/*.js" || echo "‚ö†Ô∏è  Code formatting check skipped (Prettier not configured)"
        continue-on-error: true
      
      - name: Analyze code complexity
        run: |
          echo "üìä Analyzing code complexity..."
          find src -name "*.js" -type f | head -10 | while read file; do
            lines=$(wc -l < "$file")
            echo "$file: $lines lines"
          done

  # Job 3: Integration Tests
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Wait for MongoDB
        run: |
          echo "Waiting for MongoDB to be ready..."
          sleep 5
      
      - name: Run integration tests
        run: npm run test:integration --if-present
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://localhost:27017/trello_test
          JWT_SECRET: test-secret-key-for-ci
          JWT_REFRESH_SECRET: test-refresh-secret-key-for-ci
          PORT: 3001
      
      - name: Test API endpoints
        run: |
          echo "üß™ Testing API endpoints..."
          npm start &
          SERVER_PID=$!
          sleep 5
          
          # Test health endpoint
          curl -f http://localhost:3000/health || echo "‚ö†Ô∏è  Health check failed"
          
          kill $SERVER_PID || true
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://localhost:27017/trello_test
          JWT_SECRET: test-secret-key
          JWT_REFRESH_SECRET: test-refresh-secret-key
        continue-on-error: true

  # Job 4: Size Check
  size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check repository size
        run: |
          echo "üì¶ Repository size analysis:"
          du -sh .
          echo ""
          echo "üìÅ Largest directories:"
          du -sh */ 2>/dev/null | sort -hr | head -10
      
      - name: Check node_modules size
        run: |
          npm ci
          echo "üì¶ node_modules size:"
          du -sh node_modules

